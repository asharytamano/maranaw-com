<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Maranao Tafsir</title>
  <!-- Import Amiri + Merriweather fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Amiri&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .surah-list { max-width: 300px; float: left; margin-right: 20px; }
    .surah-item { padding: 8px; cursor: pointer; border-bottom: 1px solid #ddd; }
    .surah-item:hover { background: #f0f0f0; }
    .tafsir-display { max-width: 700px; float: left; }
    .ayah { margin-bottom: 15px; padding: 10px; border-bottom: 1px solid #eee; }

    /* Arabic Qur'an text */
    .quran {
      font-family: 'Amiri', serif;
      font-size: 22px;
      line-height: 2;
      color: darkgreen;
      direction: rtl;
      text-align: right;
    }

    /* Arabic Surah name in sidebar */
    .surah-arabic {
      font-family: 'Amiri', serif;
      font-size: 18px;
      direction: rtl;
      text-align: right;
      display: block;
      color: #333;
      transition: color 0.3s, font-weight 0.3s;
    }
    .surah-item:hover .surah-arabic {
      font-weight: bold;
      color: green;
    }
    .surah-item.active .surah-arabic {
      font-weight: bold;
      color: green;
    }

    /* Translation (Maranao/English) */
    .translation {
      font-family: 'Merriweather', serif;
      font-size: 16px;
      line-height: 1.8;
      color: darkblue;
      margin-top: 5px;
      text-align: left;
    }

    /* Tafsir */
    .tafsir {
      font-family: 'Merriweather', serif;
      font-size: 15px;
      line-height: 1.8;
      margin-top: 5px;
      font-style: italic;
      display: none;
      text-align: justify;
      color: #333;
    }

    .search-box { margin-bottom: 10px; position: sticky; top: 0; background: #fff; padding: 10px; z-index: 10; border-bottom: 1px solid #ddd; }
    .pagination { margin-top: 15px; text-align: center; }
    .pagination button { margin: 0 3px; padding: 6px 12px; }
    mark { background: yellow; font-weight: bold; }
    .search-tips { font-size: 13px; color: #555; margin-top: 5px; }
  </style>
</head>
<body>
  <h1>ðŸ“– Maranao Tafsir</h1>

  <!-- ðŸ”Ž Search bar -->
  <div class="search-box">
    <input id="search-input" 
           type="text" 
           placeholder="Search keyword (e.g., iman, sabr)" 
           style="padding:6px; width:250px;"
           onkeypress="if(event.key === 'Enter'){ searchAyahs(); }">

    <button onclick="searchAyahs()" style="padding:6px 12px;">Search</button>
    <button onclick="loadSurahs()" style="padding:6px 12px;">Clear</button>
    <label style="margin-left:10px;">
      <input type="checkbox" id="exact-match"> Exact Match Only
    </label>

    <div class="search-tips">
      ðŸ”Ž Search Tips:<br>
      - Use multiple keywords (e.g., iman sabr)<br>
      - Case insensitive (Iman = iman)<br>
      - Works on Qurâ€™an text, Maranao translation, and Tafsir<br>
      - Check "Exact Match Only" to match whole words only (e.g., iman but not satiman)
    </div>
  </div>

  <div class="surah-list" id="surah-list">
    <h3>Surahs</h3>
    <div>Loading surahs...</div>
  </div>

  <div class="tafsir-display">
    <h3 id="surah-title">Select a Surah or Search</h3>
    <div id="ayahs"></div>
    <div id="pagination" class="pagination"></div>
  </div>

  <script>
    let currentResults = [];  // store current ayahs (surah or search)
    let currentPage = 1;
    const perPage = 20;

    // Render ayahs with pagination
    function renderAyahs() {
      const ayahsDiv = document.getElementById("ayahs");
      ayahsDiv.innerHTML = "";

      if (currentResults.length === 0) {
        ayahsDiv.innerHTML = "<p>No results found.</p>";
        document.getElementById("pagination").innerHTML = "";
        return;
      }

      const start = (currentPage - 1) * perPage;
      const end = start + perPage;
      const pageItems = currentResults.slice(start, end);

      pageItems.forEach((r, index) => {
        const div = document.createElement("div");
        div.className = "ayah";
        div.innerHTML = `
          <div><strong>Surah ${r.surah}, Ayah ${r.ayah}</strong></div>
          <div class="quran">${r.quran_text}</div>
          <div class="translation">ðŸ”¹ ${r.maranao_translation}</div>
          <button onclick="toggleTafsir(${index + start})" style="margin-top:5px;">Show Tafsir</button>
          <div id="tafsir-${index + start}" class="tafsir">ðŸ“– ${r.tafsir_text_original}</div>
        `;
        ayahsDiv.appendChild(div);
      });

      renderPagination();
    }

    // Render pagination with ellipsis
    function renderPagination() {
      const totalPages = Math.ceil(currentResults.length / perPage);
      const pagDiv = document.getElementById("pagination");
      pagDiv.innerHTML = "";

      if (totalPages <= 1) return;

      if (currentPage > 1) {
        const prevBtn = document.createElement("button");
        prevBtn.innerText = "Prev";
        prevBtn.onclick = () => { currentPage--; renderAyahs(); };
        pagDiv.appendChild(prevBtn);
      }

      if (currentPage > 3) {
        addPageButton(1);
        if (currentPage > 4) {
          const span = document.createElement("span");
          span.innerText = "...";
          pagDiv.appendChild(span);
        }
      }

      for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
        addPageButton(i);
      }

      if (currentPage < totalPages - 2) {
        if (currentPage < totalPages - 3) {
          const span = document.createElement("span");
          span.innerText = "...";
          pagDiv.appendChild(span);
        }
        addPageButton(totalPages);
      }

      if (currentPage < totalPages) {
        const nextBtn = document.createElement("button");
        nextBtn.innerText = "Next";
        nextBtn.onclick = () => { currentPage++; renderAyahs(); };
        pagDiv.appendChild(nextBtn);
      }

      function addPageButton(i) {
        const pageBtn = document.createElement("button");
        pageBtn.innerText = i;
        if (i === currentPage) {
          pageBtn.style.fontWeight = "bold";
          pageBtn.style.background = "#ddd";
        }
        pageBtn.onclick = () => { currentPage = i; renderAyahs(); };
        pagDiv.appendChild(pageBtn);
      }
    }

    // Load all surahs
    async function loadSurahs() {
      const res = await fetch("api/surahs.php");
      const surahs = await res.json();

      const list = document.getElementById("surah-list");
      list.innerHTML = "<h3>Surahs</h3>";

      surahs.forEach(s => {
        const div = document.createElement("div");
        div.className = "surah-item";
        div.innerHTML = `
          ${s.surah_number}. ${s.surah_name_en}
          <span class="surah-arabic">${s.surah_name_ar}</span>
        `;
        div.onclick = () => {
          // remove active from all
          document.querySelectorAll(".surah-item").forEach(item => item.classList.remove("active"));
          // set this one active
          div.classList.add("active");
          loadSurah(s.surah_number, s.surah_name_en, s.surah_name_ar);
        };
        list.appendChild(div);
      });

      document.getElementById("surah-title").innerText = "Select a Surah or Search";
      document.getElementById("ayahs").innerHTML = "";
      document.getElementById("pagination").innerHTML = "";
    }

    // Load one surah
    async function loadSurah(id, nameEn, nameAr) {
      const res = await fetch("api/surah.php?id=" + id);
      const surah = await res.json();

      document.getElementById("surah-title").innerText =
        surah.surah_number + ". " + nameEn + " (" + nameAr + ")";

      currentResults = surah.ayahs;
      currentPage = 1;
      renderAyahs();
    }

    // Search with highlight + exact option
    async function searchAyahs() {
      const q = document.getElementById("search-input").value.trim();
      const exact = document.getElementById("exact-match").checked ? 1 : 0;

      if (!q) {
        alert("Enter a keyword to search");
        return;
      }

      document.getElementById("surah-title").innerText = "Search results for: " + q;
      document.getElementById("ayahs").innerHTML = "Searching...";

      const res = await fetch("api/search.php?q=" + encodeURIComponent(q) + "&exact=" + exact);
      let results = await res.json();

      const keywords = q.split(/\s+/).filter(k => k.length > 0);
      const regex = new RegExp("(" + keywords.join("|") + ")", "gi");
      results = results.map(r => ({
        ...r,
        quran_text: r.quran_text.replace(regex, "<mark>$1</mark>"),
        maranao_translation: r.maranao_translation.replace(regex, "<mark>$1</mark>"),
        tafsir_text_original: r.tafsir_text_original.replace(regex, "<mark>$1</mark>")
      }));

      currentResults = results;
      currentPage = 1;
      renderAyahs();

      // remove active highlight when searching
      document.querySelectorAll(".surah-item").forEach(item => item.classList.remove("active"));
    }

    // Toggle tafsir
    function toggleTafsir(index) {
      document.querySelectorAll(".tafsir").forEach(div => div.style.display = "none");
      document.querySelectorAll(".ayah button").forEach(btn => btn.innerText = "Show Tafsir");

      const tafsirDiv = document.getElementById("tafsir-" + index);
      const button = tafsirDiv.previousElementSibling;

      tafsirDiv.style.display = "block";
      button.innerText = "Hide Tafsir";
    }

    loadSurahs();
  </script>
</body>
</html>
